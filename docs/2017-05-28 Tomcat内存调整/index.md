# Tomcat内存调整

---

Tomcat本身不能直接在计算机上运行，需要依赖于硬件基础之上的操作系统和一个Java虚拟机。Java程序启动时JVM都会分配一个初始内存和最大内存给这个应用程序。这个初始内存和最大内存在一定程度上都会影响程序的性能。比如说在应用程序用到最大内存的时候，JVM是要先去做垃圾回收的动作，释放被占用的一些内存。所以想调整Tomcat的启动时初始内存和最大内存就需要向JVM声明，一般的Java程序在运行都可以通过中-Xms和-Xmx来调整应用程序的初始内存和最大内存。这两个值的大小一般根据需要进行设置，初始化堆的大小执行了虚拟机在启动时向系统申请的内存的大小。一般而言，这个参数不重要。但是有的应用程序在大负载的情况下会急剧地占用更多的内存，此时这个参数就是显得非常重要。如果虚拟机启动时设置使用的内存比较小而在这种情况下有许多对象进行初始化，虚拟机就必须重复地增加内存来满足使用。由于这种原因，我们一般把-Xms和-Xmx设为一样大。而堆的最大值受限于系统使用的物理内存，一般使用数据量较大的应用程序会使用持久对象，内存使用有可能迅速地增长。当应用程序需要的内存超出堆的最大值时虚拟机就会提示内存溢出，并且导致应用服务崩溃。因此一般建议堆的最大值设置为可用内存的最大值的80%。

Tomcat默认可以使用的内存为128MB，在较大型的应用项目中，这点内存是不够的，需要调大。有以下几种方法可以选用：

* 第一种方法：

Windows下，在文件`/bin/catalina.bat`，Unix下，在文件`/bin/catalina.sh`的前面，增加如下设置：

~~~plaintext
JAVA_OPTS='-Xms【初始化内存大小】 -Xmx【可以使用的最大内存】'
~~~

需要把这个两个参数值调大。例如：

~~~plaintext
JAVA_OPTS='-Xms256m -Xmx512m'
~~~

表示初始化内存为256MB，可以使用的最大内存为512MB。

* 第二种方法： 

环境变量中设置，变量名：JAVA_OPTS， 变量值：-Xms512m   -Xmx512m

* 第三种方法：

前两种方法针对的是bin目录下有`catalina.bat`的情况（比如直接解压的Tomcat等）。但是有些安装版的Tomcat下没有`catalina.bat`，这个时候可以采用如下方法，当然这个方法也是最通用的方法：打开`%TOMCAT_HOME%/bin/tomcat5w.exe`，点击Java选项卡，然后将会发现其中有这么两项：`Initial memory pool`和`Maximum memory pool`。`Initial memory pool`就是初始化设置的内存的大小，`Maximum memory pool`是最大内存的大小。设置完了就按确定然后再重启Tomcat你就会发现Tomcat中JVM可用的内存改变了。

另外需要考虑的是Java提供的垃圾回收机制。虚拟机的堆大小决定了虚拟机花费在收集垃圾上的时间和频度。收集垃圾可以接受的速度与应用有关，应该通过分析实际的垃圾收集的时间和频率来调整。如果堆的大小很大，那么完全垃圾收集就会很慢，但是频度会降低。如果你把堆的大小和内存的需要一致，完全收集就很快，但是会更加频繁。调整堆大小的的目的是最小化垃圾收集的时间，以在特定的时间内最大化处理客户的请求。在基准测试的时候，为保证最好的性能，要把堆的大小设大，保证垃圾收集不在整个基准测试的过程中出现。如果系统花费很多的时间收集垃圾，请减小堆大小。一次完全的垃圾收集应该不超过 3-5 秒。如果垃圾收集成为瓶颈，那么需要指定堆的大小，检查垃圾收集的详细输出，研究垃圾收集参数对性能的影响。一般说来，你应该使用物理内存的 80% 作为堆大小。当增加处理器时，记得增加内存，因为分配可以并行进行，而垃圾收集不是并行的。

一个要注意的地方：建议把内存的最高值跟最低值的差值缩小，不然会浪费很多内存的。 最低值加大 ，最高值可以随便设，但是要根据实际的物理内存 。如果内存设置太大了，比如设置了512M最大内存，但如果没有512M可用内存，Tomcat就不能启动，还有可能存在内存被系统回收，终止进程的情况。

**参考文档：**

* [Tomcat内存大小调整](https://blog.csdn.net/coolwzjcool/article/details/2544448)



<br/><br/><br/>

---

